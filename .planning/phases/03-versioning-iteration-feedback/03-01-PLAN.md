---
phase: 03-versioning-iteration-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/projects/[projectId]/versions/route.ts
  - src/app/api/projects/[projectId]/versions/[versionId]/route.ts
  - src/lib/db/versions.ts
  - src/components/version/version-list.tsx
  - src/components/version/version-compare.tsx
  - src/components/version/project-view.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a timestamped list of all versions with human-readable relative times (e.g. '2 hours ago')"
    - "User can provide feedback on an existing version and see the new version appear in the sidebar without a full page reload"
    - "User can compare any two versions side-by-side with word-level diff highlighting showing additions and deletions"
    - "User can select which version to compare against the current version via a dropdown"
  artifacts:
    - path: "src/app/api/projects/[projectId]/versions/route.ts"
      provides: "Firestore timestamp to ISO string conversion in version list API"
      contains: "toDate"
    - path: "src/components/version/version-list.tsx"
      provides: "Formatted timestamps in version list items"
      contains: "formatDistanceToNow"
    - path: "src/components/version/version-compare.tsx"
      provides: "Text diff highlighting with react-diff-viewer-continued"
      contains: "react-diff-viewer-continued"
    - path: "src/components/version/project-view.tsx"
      provides: "State-based refresh after iteration, version picker for compare"
      contains: "versionListKey"
  key_links:
    - from: "src/lib/db/versions.ts"
      to: "src/app/api/projects/[projectId]/versions/route.ts"
      via: "getAllVersions returns StoredVersion with typed createdAt"
      pattern: "createdAt.*toDate.*toISOString"
    - from: "src/components/version/project-view.tsx"
      to: "src/components/version/version-list.tsx"
      via: "refreshKey prop triggers re-fetch after iteration"
      pattern: "versionListKey|key=.*Key"
    - from: "src/components/version/project-view.tsx"
      to: "src/components/version/version-compare.tsx"
      via: "compareTargetId from version selector dropdown"
      pattern: "compareTargetId|handleCompare"
---

<objective>
Enhance existing version management UI with timestamp display, diff highlighting, flexible version comparison, and state-based iteration refresh.

Purpose: Close the remaining gaps in Phase 3 requirements -- the backend and most UI already exist from Phases 1-2, but timestamps aren't displayed, compare view lacks diff highlighting, compare is hardcoded to initial version, and iteration uses window.location.reload().

Output: Fully functional version history with timestamps, proper diff-highlighted compare view with version picker, and smooth state-based iteration flow.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-versioning-iteration-feedback/03-RESEARCH.md
@src/components/version/project-view.tsx
@src/components/version/version-list.tsx
@src/components/version/version-compare.tsx
@src/lib/db/versions.ts
@src/app/api/projects/[projectId]/versions/route.ts
@src/app/api/projects/[projectId]/versions/[versionId]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix timestamp serialization and add formatted timestamps to version list</name>
  <files>
    src/lib/db/versions.ts
    src/app/api/projects/[projectId]/versions/route.ts
    src/app/api/projects/[projectId]/versions/[versionId]/route.ts
    src/components/version/version-list.tsx
  </files>
  <action>
    **1. Fix `StoredVersion` type in `src/lib/db/versions.ts`:**
    - Change `createdAt: unknown` to a proper Firestore Timestamp type. Import `Timestamp` from `firebase-admin/firestore`. Type the field as `Timestamp | null` since serverTimestamp() returns Timestamp after being read back.
    - Update the type assertions in `getVersion`, `getAllVersions`, and `getLatestVersion` to match the new type.

    **2. Convert Firestore timestamps to ISO strings in the versions list API (`src/app/api/projects/[projectId]/versions/route.ts`):**
    - In the sanitized mapping (line 22), also convert `createdAt` from Firestore Timestamp to ISO string:
      ```
      createdAt: rest.createdAt && typeof rest.createdAt === 'object' && 'toDate' in rest.createdAt
        ? (rest.createdAt as { toDate(): Date }).toDate().toISOString()
        : null
      ```
    - This ensures the frontend receives `createdAt` as a string, not a Firestore Timestamp object.

    **3. Convert timestamp in single version API (`src/app/api/projects/[projectId]/versions/[versionId]/route.ts`):**
    - Apply the same Firestore Timestamp-to-ISO-string conversion when returning the single version response.

    **4. Add formatted timestamps to `src/components/version/version-list.tsx`:**
    - Change `VersionSummary.createdAt` type from `unknown` to `string | null`.
    - Import `formatDistanceToNow` from `date-fns` (already installed as date-fns@4.1.0).
    - Create a helper: `function formatTimestamp(createdAt: string | null): string { if (!createdAt) return ''; return formatDistanceToNow(new Date(createdAt), { addSuffix: true }); }`
    - Display the formatted timestamp next to the existing Clock icon in each version row. Replace the bare `<Clock>` icon with `<span className="text-xs text-gray-400">{formatTimestamp(v.createdAt)}</span>`. Keep the Clock icon as a decorative prefix.
  </action>
  <verify>
    Run `npm run build` -- no type errors. Run `npm run lint` -- clean. Start the dev server and visit a project with existing versions -- each version in the sidebar should display a relative timestamp like "2 hours ago" or "3 days ago" next to the Clock icon.
  </verify>
  <done>
    Version list displays human-readable relative timestamps for every version. API returns `createdAt` as ISO string (not raw Firestore Timestamp object). `StoredVersion.createdAt` is properly typed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace page reload with state-based refresh, add diff viewer and version picker to compare</name>
  <files>
    src/components/version/project-view.tsx
    src/components/version/version-compare.tsx
    src/components/version/version-list.tsx
  </files>
  <action>
    **1. Install react-diff-viewer-continued:**
    - Run `npm install react-diff-viewer-continued` (v4.1.2+, React 19 compatible).

    **2. Replace `window.location.reload()` with state-based refresh in `src/components/version/project-view.tsx`:**
    - Add a `versionListKey` state: `const [versionListKey, setVersionListKey] = useState(0);`
    - In `handleIterationComplete`, remove `window.location.reload()` and instead:
      - Set `activeVersionId` to `newVersionId` (rename the `_newVersionId` parameter)
      - Set `markdown` to `newMarkdown`
      - Set `rating` to `undefined`
      - Set `viewMode` to `"view"`
      - Increment `versionListKey`: `setVersionListKey(prev => prev + 1)`
    - Pass `key={versionListKey}` to the `<VersionList>` component so it re-mounts and re-fetches when the key changes.

    **3. Add version picker for compare in `src/components/version/project-view.tsx`:**
    - Add state: `const [versions, setVersions] = useState<Array<{id: string; versionNumber: number}>>([]);`
    - Add state: `const [compareTargetId, setCompareTargetId] = useState<string>("");`
    - Add a `useEffect` that fetches `/api/projects/${projectId}/versions` and stores the result in `versions` state. Include `versionListKey` as a dependency so the version list refreshes after iteration.
    - Modify the "Compare" button: instead of directly calling `handleCompare(initialVersionId)`, set `viewMode` to `"compare"`. (The compare view will have its own version selector.)
    - In the compare view section (`viewMode === "compare"`), render a `<select>` dropdown above the diff viewer listing all versions except the currently active one. When user selects a version, call `handleCompare` with that version's ID to fetch its content. Default to the first available version (or the initial version if it differs from active).
    - Update `handleCompare` to also set `compareTargetId` so the select stays in sync.

    **4. Replace side-by-side markdown with diff viewer in `src/components/version/version-compare.tsx`:**
    - Remove `react-markdown` and `remark-gfm` imports.
    - Use dynamic import for `react-diff-viewer-continued` with `ssr: false` to avoid hydration issues:
      ```tsx
      import dynamic from 'next/dynamic';
      const ReactDiffViewer = dynamic(() => import('react-diff-viewer-continued'), { ssr: false });
      ```
    - Replace the two-column markdown rendering grid with a single `<ReactDiffViewer>` component:
      - `oldValue={leftMarkdown}` `newValue={rightMarkdown}`
      - `splitView={true}` for side-by-side
      - `compareMethod={DiffMethod.WORDS}` for word-level diff (import `DiffMethod` from the same package; if dynamic import prevents static enum import, use the string value `"diffWords"` or import the enum separately)
      - `useDarkTheme={false}`
    - Keep the header with `leftLabel` and `rightLabel` above the diff viewer.
    - Note: Since we're using dynamic import for the default export, the `DiffMethod` enum needs a separate static import. If that causes issues, just omit `compareMethod` (the default `DiffMethod.CHARS` is acceptable) or use a separate import for just the enum: `import { DiffMethod } from 'react-diff-viewer-continued';` (this static import is fine since the enum is just a plain object, not a React component).

    **5. Update VersionList to accept external key for re-mounting (`src/components/version/version-list.tsx`):**
    - No interface change needed -- React's `key` prop on VersionList in ProjectView will trigger unmount/remount, causing useEffect to re-run and re-fetch versions.
  </action>
  <verify>
    Run `npm run build` -- no type errors. Run `npm run lint` -- clean.

    Test state refresh: Start dev server, go to a project with an existing FRD, click "Iterate", submit feedback, verify the new version appears in the sidebar WITHOUT a full page reload, and the main view shows the new version content.

    Test compare: Click "Compare", verify a dropdown appears listing all versions except the active one, select a version, verify the diff viewer renders with additions highlighted in green and deletions in red. Switch which version to compare -- the diff updates.
  </verify>
  <done>
    After iteration, new version appears in sidebar immediately via state refresh (no window.location.reload). Compare view uses react-diff-viewer-continued with word-level diff highlighting. User can select any version to compare against via dropdown.
  </done>
</task>

</tasks>

<verification>
1. VER-02: Version list shows timestamps -- each version row displays a relative time like "2 hours ago"
2. VER-03: Can click any version in sidebar and read its full content (already worked, still works)
3. VER-04: Can click Iterate, provide feedback, and generate a new version (already worked, now without page reload)
4. VER-05: New iteration version appears in sidebar immediately, linked to parent (GitBranch icon shown)
5. VER-06: Compare view shows word-level diff highlighting with version picker dropdown
6. RATE-01/02/03: Rating widget works after generation (already worked, still works)
7. AUTH-04: Prompt view shows composed prompt (already worked, still works)
8. Build passes: `npm run build` exits 0
9. Lint passes: `npm run lint` exits 0
</verification>

<success_criteria>
- `npm run build` and `npm run lint` pass with zero errors
- Version list displays relative timestamps for all versions
- Iteration creates new version that appears in sidebar without page reload
- Compare view renders word-level diffs with green/red highlighting
- Compare mode includes version picker dropdown for selecting comparison target
- All existing functionality (view, iterate, prompt, rating) continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/03-versioning-iteration-feedback/03-01-SUMMARY.md`
</output>
