---
phase: 02-dual-mode-input-gap-detection
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - tests/lib/validation/generation.test.ts
  - tests/components/generation/standard-mode-flow.test.tsx
  - tests/components/generation/model-selector.test.tsx
  - tests/components/generation/gap-follow-ups.test.tsx
autonomous: true

must_haves:
  truths:
    - "Validation schema tests prove brainDump.min(50) is enforced for fast mode and bypassed for standard mode"
    - "Validation schema tests prove modelId enum accepts gemini-3-pro-preview and rejects gemini-3-pro"
    - "Validation schema tests prove GapDetectionRequestSchema accepts valid requests and rejects invalid modelId"
    - "Standard mode flow tests prove required questions block advancement when unanswered"
    - "Standard mode flow tests prove skip button is hidden for required questions"
    - "Standard mode flow tests prove minimum answer warning appears when < 2 answers"
    - "Model selector tests prove both model IDs are rendered and selection works"
    - "Gap follow-ups tests prove each gap renders with section, description, and follow-up prompt"
    - "Gap follow-ups tests prove skip-all button calls onSkipAll handler (FAST-04)"
    - "Gap follow-ups tests prove only non-empty answers are collected in submission (FAST-04)"
  artifacts:
    - path: "tests/lib/validation/generation.test.ts"
      provides: "Validation schema tests for conditional brainDump, modelId enum, standard mode, and gap detection schema"
      min_lines: 50
    - path: "tests/components/generation/standard-mode-flow.test.tsx"
      provides: "Standard mode flow component tests"
      min_lines: 50
    - path: "tests/components/generation/model-selector.test.tsx"
      provides: "Model selector component tests"
      min_lines: 30
    - path: "tests/components/generation/gap-follow-ups.test.tsx"
      provides: "Gap follow-ups component tests for rendering, skip, and answer collection"
      min_lines: 40
  key_links:
    - from: "tests/lib/validation/generation.test.ts"
      to: "src/lib/validation/generation.ts"
      via: "imports and validates GenerationRequestSchema, GapDetectionRequestSchema"
      pattern: "import.*GenerationRequestSchema"
    - from: "tests/components/generation/standard-mode-flow.test.tsx"
      to: "src/components/generation/standard-mode-flow.tsx"
      via: "imports and renders StandardModeFlow"
      pattern: "import.*StandardModeFlow"
    - from: "tests/components/generation/model-selector.test.tsx"
      to: "src/components/generation/model-selector.tsx"
      via: "imports and renders ModelSelector"
      pattern: "import.*ModelSelector"
    - from: "tests/components/generation/gap-follow-ups.test.tsx"
      to: "src/components/generation/gap-follow-ups.tsx"
      via: "imports and renders GapFollowUps with mock gaps"
      pattern: "import.*GapFollowUps"
---

<objective>
Add comprehensive tests for Phase 2 functionality: validation schemas, standard mode flow, model selector, and gap detection follow-ups.

Purpose: Phase 2 enables existing but untested code (gap detection, standard mode, model selection). Tests verify the bug fixes from Plan 02-01 are correct, confirm the gap detection pipeline UI works as designed (FAST-02 through FAST-04), and prevent regressions. The validation schema tests verify conditional brainDump logic and gap detection schema. The gap follow-ups tests verify the skip and answer collection contract.

Output: Four test files covering validation schemas, standard mode flow, model selector, and gap follow-ups. All tests pass via `npm test`.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dual-mode-input-gap-detection/02-RESEARCH.md
@.planning/phases/02-dual-mode-input-gap-detection/02-01-SUMMARY.md
@src/lib/validation/generation.ts
@src/components/generation/standard-mode-flow.tsx
@src/components/generation/model-selector.tsx
@src/lib/standard-mode-questions.ts
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD validation schema tests</name>
  <files>
    tests/lib/validation/generation.test.ts
  </files>
  <action>
  Create test file for `GenerationRequestSchema` and `GapDetectionRequestSchema` using Vitest. Import from `@/lib/validation/generation`. Use `describe`/`it` blocks.

  **RED phase — write these tests first (they should all pass against the fixed code from 02-01):**

  `describe("GenerationRequestSchema")`:
  1. `it("accepts fast mode with brainDump >= 50 chars")` — parse a valid fast mode request with 50+ char brainDump. Expect success.
  2. `it("rejects fast mode with brainDump < 50 chars")` — parse a fast mode request with 10 char brainDump. Expect ZodError with path `["brainDump"]`.
  3. `it("accepts standard mode with empty brainDump")` — parse a valid standard mode request with `brainDump: ""` and `guidedAnswers: [{section: "Overview", question: "...", answer: "..."}]`. Expect success.
  4. `it("accepts standard mode with missing brainDump")` — parse standard mode with `brainDump: ""`. Expect success (no guidedAnswers required by schema, just empty brainDump allowed).
  5. `it("rejects brainDump over 15000 chars")` — parse with a 15001 char brainDump. Expect ZodError.
  6. `it("accepts modelId gemini-2.5-flash")` — parse with `modelId: "gemini-2.5-flash"`. Expect success.
  7. `it("accepts modelId gemini-3-pro-preview")` — parse with `modelId: "gemini-3-pro-preview"`. Expect success.
  8. `it("rejects modelId gemini-3-pro (without -preview)")` — parse with `modelId: "gemini-3-pro"`. Expect ZodError.
  9. `it("defaults modelId to undefined when not provided")` — parse without modelId field. Expect success, result.modelId is undefined.

  `describe("GapDetectionRequestSchema")`:
  10. `it("accepts valid gap detection request")` — parse with projectName, brainDump (50+ chars). Expect success.
  11. `it("accepts modelId gemini-3-pro-preview")` — Expect success.
  12. `it("rejects modelId gemini-3-pro (without -preview)")` — Expect ZodError.
  13. `it("rejects brainDump under 50 chars")` — parse with 10-char brainDump. Expect ZodError with path `["brainDump"]`.
  14. `it("requires projectName")` — parse with empty projectName. Expect ZodError.

  Use a helper function for the base valid request to avoid repetition:
  ```typescript
  const validFastRequest = {
    projectId: "test-project-id",
    projectName: "Test Project",
    brainDump: "A".repeat(50),
    mode: "fast" as const,
  };
  ```

  **GREEN phase:** Tests should pass against the fixed code from 02-01. If any fail, investigate — the fix in 02-01 may need adjustment.

  **REFACTOR phase:** Clean up any duplication in test helpers.
  </action>
  <verify>
  Run `npx vitest run tests/lib/validation/generation.test.ts` — all tests pass.
  Verify test count matches expected (14 tests).
  </verify>
  <done>
  14 validation schema tests pass, covering: conditional brainDump validation (fast mode enforces min 50, standard mode allows empty), modelId enum (accepts gemini-3-pro-preview, rejects gemini-3-pro), GapDetectionRequestSchema validation (brainDump min, projectName required, modelId enum), and basic field validation. Tests import from the actual validation module and use real Zod parsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD standard mode flow and model selector tests</name>
  <files>
    tests/components/generation/standard-mode-flow.test.tsx
    tests/components/generation/model-selector.test.tsx
  </files>
  <action>
  Create component test files using Vitest + React Testing Library (@testing-library/react). If `@testing-library/react` is not installed, install it along with `@testing-library/jest-dom` as dev dependencies. Check `package.json` first.

  **tests/components/generation/standard-mode-flow.test.tsx:**

  Import `StandardModeFlow` from `@/components/generation/standard-mode-flow`. Use `render`, `screen`, `fireEvent` from `@testing-library/react`.

  `describe("StandardModeFlow")`:
  1. `it("renders first question with progress bar")` — render component, verify question text visible, progress bar visible, "Question 1 of 8" text.
  2. `it("advances to next question on Next click when answer provided")` — type in textarea, click Next, verify "Question 2 of 8" visible.
  3. `it("blocks advancement on required question with no answer")` — on first question (required), click Next without typing. Verify "This question is required" warning appears. Verify still on "Question 1 of 8".
  4. `it("hides Skip button for required questions")` — on first question (required), verify Skip button is NOT in the document. Navigate to a non-required question (e.g., question 5 "secondary-features"), verify Skip button IS visible.
  5. `it("shows Skip button for optional questions")` — navigate to question 5 (first optional), verify Skip button present.
  6. `it("shows minimum answer warning when submitting with < 2 answers")` — answer only question 1, navigate to last question, click Generate FRD. Verify warning banner appears with "at least 2 questions" text.
  7. `it("allows forced submit via Generate anyway button")` — trigger the warning, then click "Generate anyway". Verify `onSubmit` was called.
  8. `it("submits directly when >= 2 answers provided")` — answer questions 1 and 2, navigate to last, click Generate FRD. Verify `onSubmit` called without warning.
  9. `it("collects only non-empty answers in submission")` — answer questions 1, 2, 3, skip 4-8. Verify `onSubmit` called with exactly 3 GuidedAnswer objects.

  Use `vi.fn()` for `onSubmit` prop. Use `isSubmitting: false` for all tests.

  **tests/components/generation/model-selector.test.tsx:**

  Import `ModelSelector` from `@/components/generation/model-selector`.

  `describe("ModelSelector")`:
  1. `it("renders both model options")` — render with `value="gemini-2.5-flash"`. Verify "Gemini 2.5 Flash" and "Gemini 3 Pro" text visible.
  2. `it("highlights selected model")` — render with `value="gemini-2.5-flash"`. Verify Flash button has selected styling class. Verify Pro does not.
  3. `it("calls onChange with correct model ID on click")` — click Gemini 3 Pro button. Verify `onChange` called with `"gemini-3-pro-preview"`.
  4. `it("uses gemini-3-pro-preview as the Pro model ID")` — render, click Pro button. Verify onChange called with `"gemini-3-pro-preview"` (not `"gemini-3-pro"`).

  **GREEN phase:** All tests should pass against the fixed code from 02-01.

  **REFACTOR phase:** Extract shared render helpers if there is duplication.
  </action>
  <verify>
  Run `npx vitest run tests/components/` — all tests pass.
  Verify test counts: ~9 standard mode tests, ~4 model selector tests.
  Run `npm test` — full test suite passes (includes both test files plus validation tests from Task 1).
  </verify>
  <done>
  13 component tests pass covering: StandardModeFlow (progress rendering, required question enforcement, skip button visibility, minimum answer warning with escape hatch, answer collection) and ModelSelector (rendering, selection highlighting, correct model ID on click). All tests use React Testing Library and verify actual user interactions.
  </done>
</task>

<task type="auto">
  <name>Task 3: TDD gap follow-ups component tests (FAST-02 through FAST-04)</name>
  <files>
    tests/components/generation/gap-follow-ups.test.tsx
  </files>
  <action>
  Create test file for `GapFollowUps` component using Vitest + React Testing Library. Import from `@/components/generation/gap-follow-ups`.

  **Setup — create a mock gaps array for all tests:**
  ```typescript
  const mockGaps = [
    {
      section: "Personas",
      description: "No target users described",
      followUpPrompt: "Who are the primary users of this system?",
      importance: "high" as const,
    },
    {
      section: "Requirements",
      description: "Missing authentication details",
      followUpPrompt: "What authentication method should be used?",
      importance: "medium" as const,
    },
    {
      section: "Constraints",
      description: "No performance requirements mentioned",
      followUpPrompt: "Are there any performance or scalability requirements?",
      importance: "low" as const,
    },
  ];
  ```

  **RED phase — write these tests first:**

  `describe("GapFollowUps")`:
  1. `it("renders all gaps with section names and descriptions")` — render with `mockGaps`. Verify all three section names visible ("Personas", "Requirements", "Constraints"). Verify all three descriptions visible.
  2. `it("renders follow-up prompts as textarea labels")` — verify "Who are the primary users of this system?" is visible as a label.
  3. `it("renders importance badges with correct styling")` — verify "high", "medium", "low" badge text is present for each gap.
  4. `it("calls onSkipAll when Skip & Generate Now is clicked")` — render with `onSkipAll` as `vi.fn()`, click "Skip & Generate Now" button, verify `onSkipAll` was called once.
  5. `it("collects only non-empty answers on submit")` — type "Product managers" in first gap's textarea, leave second and third empty, submit the form. Verify `onSubmit` was called with exactly 1 FollowUpAnswer: `[{ section: "Personas", question: "Who are the primary users of this system?", answer: "Product managers" }]`.
  6. `it("submits all answered gaps")` — fill in answers for gap 0 and gap 1, leave gap 2 empty. Submit. Verify `onSubmit` called with 2 answers.
  7. `it("submits empty array when no answers provided")` — submit form without typing anything. Verify `onSubmit` called with `[]`.
  8. `it("shows answered badge when gap has non-empty answer")` — type an answer in first gap's textarea. Verify "answered" badge text appears.
  9. `it("disables buttons when isSubmitting is true")` — render with `isSubmitting: true`. Verify both "Skip & Generate Now" and the submit button are disabled.

  **GREEN phase:** Tests should pass against existing `gap-follow-ups.tsx` component from Phase 1.

  **REFACTOR phase:** Extract shared render helper if duplication exists.
  </action>
  <verify>
  Run `npx vitest run tests/components/generation/gap-follow-ups.test.tsx` — all tests pass.
  Verify test count matches expected (9 tests).
  </verify>
  <done>
  9 gap follow-ups component tests pass, covering: gap rendering (sections, descriptions, importance badges, follow-up prompts), skip-all functionality (FAST-04), answer collection (only non-empty answers included, empty submissions valid), answered badge display, and disabled state during submission. Tests verify the complete gap detection UI contract.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with zero failures
2. At least 36 total tests across all four files
3. Validation tests cover: fast mode brainDump min, standard mode brainDump bypass, modelId enum, max length, GapDetectionRequestSchema validation
4. Standard mode tests cover: required question enforcement, skip visibility, minimum answer warning, forced submit
5. Model selector tests cover: rendering both options, correct model ID passed on click
6. Gap follow-ups tests cover: gap rendering, skip-all (FAST-04), answer collection, answered badge, submit disabled state
7. `npm run build` still passes (tests don't break build)
8. `npm run lint` still passes
</verification>

<success_criteria>
- All Phase 2 tests pass via `npm test`
- Tests verify the critical bug fixes from Plan 02-01 (model ID, brainDump validation, standard mode)
- Tests verify gap detection UI contract (gap rendering, skip-all, answer collection) per FAST-02 through FAST-04
- Tests verify GapDetectionRequestSchema validation (brainDump min, projectName required, modelId enum)
- Tests document expected behavior for future developers
- No test relies on mocked validation — uses real Zod schemas
- Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-dual-mode-input-gap-detection/02-02-SUMMARY.md`
</output>
