---
phase: 02-dual-mode-input-gap-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/models.ts
  - src/lib/validation/generation.ts
  - src/components/generation/mode-selector.tsx
  - src/components/generation/model-selector.tsx
  - src/components/generation/standard-mode-flow.tsx
autonomous: true

must_haves:
  truths:
    - "User can select Standard mode on the mode selection screen (not disabled, no Coming Soon badge)"
    - "User can select Gemini 3 Pro in the model selector and the correct model ID (gemini-3-pro-preview) is sent to the API"
    - "Standard mode submissions with empty brainDump pass API validation (no 400 error from brainDump.min(50))"
    - "Standard mode required questions show validation warning when user tries to advance without answering"
    - "Standard mode shows a non-blocking warning when fewer than 2 questions are answered before submitting"
    - "Brain dump submission in Fast mode triggers gap detection API call (FAST-02)"
    - "Gap detection results render as follow-up prompts with section, description, and importance (FAST-03)"
    - "Follow-up answers merge with brain dump and are sent to the generate API (FAST-03/FAST-05)"
    - "User can skip any individual follow-up or skip all follow-ups without breaking the generation flow (FAST-04)"
  artifacts:
    - path: "src/lib/ai/models.ts"
      provides: "Corrected Gemini 3 Pro model ID"
      contains: "gemini-3-pro-preview"
    - path: "src/lib/validation/generation.ts"
      provides: "Conditional brainDump validation and corrected model ID enums"
      contains: "gemini-3-pro-preview"
    - path: "src/components/generation/mode-selector.tsx"
      provides: "Standard mode enabled"
      contains: "disabled: false"
    - path: "src/components/generation/model-selector.tsx"
      provides: "Corrected model ID in client-side selector"
      contains: "gemini-3-pro-preview"
    - path: "src/components/generation/standard-mode-flow.tsx"
      provides: "Required question enforcement and minimum answer warning"
    - path: "src/app/api/analyze-gaps/route.ts"
      provides: "Gap detection POST endpoint with auth, rate limiting, and validation"
      exports: ["POST"]
    - path: "src/lib/ai/gap-detection-engine.ts"
      provides: "analyzeGaps function using AI SDK structured output"
      exports: ["analyzeGaps"]
    - path: "src/lib/ai/gap-detection-schema.ts"
      provides: "GapSchema Zod schema for structured gap analysis output"
      exports: ["GapSchema", "GapAnalysis", "Gap"]
    - path: "src/components/generation/gap-follow-ups.tsx"
      provides: "Gap follow-up UI with per-gap answers and skip-all functionality"
      exports: ["GapFollowUps"]
    - path: "src/lib/ai/prompt-composer.ts"
      provides: "Prompt assembly merging brain dump + follow-up answers for generation"
      exports: ["composeGenerationPrompt"]
  key_links:
    - from: "src/components/generation/model-selector.tsx"
      to: "src/lib/ai/models.ts"
      via: "model ID string match"
      pattern: "gemini-3-pro-preview"
    - from: "src/components/generation/generation-flow.tsx"
      to: "src/lib/validation/generation.ts"
      via: "API request body validated by GenerationRequestSchema"
      pattern: "mode.*standard.*brainDump"
    - from: "src/components/generation/mode-selector.tsx"
      to: "src/components/generation/generation-flow.tsx"
      via: "mode prop passed through to GenerationFlow"
      pattern: "mode.*standard"
    - from: "src/components/generation/generation-flow.tsx"
      to: "/api/analyze-gaps"
      via: "handleBrainDumpSubmit calls authedFetch POST to analyze-gaps endpoint"
      pattern: "authedFetch.*analyze-gaps"
    - from: "src/app/api/analyze-gaps/route.ts"
      to: "src/lib/ai/gap-detection-engine.ts"
      via: "imports and calls analyzeGaps with projectName, brainDump, modelId"
      pattern: "analyzeGaps"
    - from: "src/components/generation/generation-flow.tsx"
      to: "src/components/generation/gap-follow-ups.tsx"
      via: "renders GapFollowUps when state is follow-ups, passes gaps and handlers"
      pattern: "GapFollowUps.*gaps.*onSubmit.*onSkipAll"
    - from: "src/components/generation/generation-flow.tsx"
      to: "/api/generate"
      via: "generateWithInput sends brainDump + followUpAnswers to generate endpoint"
      pattern: "followUpAnswers.*generate"
    - from: "src/lib/ai/prompt-composer.ts"
      to: "generation prompt"
      via: "composeGenerationPrompt assembles brain dump + follow-up answers into prompt"
      pattern: "followUpAnswers.*section.*question.*answer"
---

<objective>
Fix critical bugs (model ID, validation schema) and enable Standard mode for Phase 2 dual-mode input.

Purpose: The gap detection pipeline, standard mode flow, and model selector already exist from Phase 1 forward-building, but contain three critical bugs and one disabled feature that block Phase 2 requirements. This plan fixes all blocking issues to make both modes and both model tiers functional.

Output: All five source files updated with bug fixes and feature enablement. Both Fast and Standard modes selectable and functional. Both Gemini 2.5 Flash and Gemini 3 Pro selectable with correct model IDs.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dual-mode-input-gap-detection/02-RESEARCH.md
@src/lib/ai/models.ts
@src/lib/validation/generation.ts
@src/components/generation/mode-selector.tsx
@src/components/generation/model-selector.tsx
@src/components/generation/standard-mode-flow.tsx
@src/components/generation/generation-flow.tsx
@src/lib/standard-mode-questions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Gemini 3 Pro model ID and enable Standard mode</name>
  <files>
    src/lib/ai/models.ts
    src/components/generation/mode-selector.tsx
    src/components/generation/model-selector.tsx
  </files>
  <action>
  Fix the Gemini 3 Pro model ID bug across all three files, and enable Standard mode in the mode selector.

  **src/lib/ai/models.ts:**
  - Change the MODELS object key from `"gemini-3-pro"` to `"gemini-3-pro-preview"`
  - Change the `id` field inside from `"gemini-3-pro"` to `"gemini-3-pro-preview"`
  - Keep `name`, `description`, and `maxOutputTokens` unchanged
  - The `ModelId` type will automatically update since it's `keyof typeof MODELS`
  - Add a comment: `// Note: ID may change to "gemini-3-pro" when model reaches GA`

  **src/components/generation/model-selector.tsx:**
  - Change the `id` field in the models array from `"gemini-3-pro"` to `"gemini-3-pro-preview"`
  - Keep `name: "Gemini 3 Pro"` and other fields unchanged

  **src/components/generation/mode-selector.tsx:**
  - Change Standard mode's `disabled` from `true` to `false`
  - Change Standard mode's `badge` from `"Coming Soon" as string | null` to `null as string | null`
  </action>
  <verify>
  Run `npm run build` — must pass with zero errors (TypeScript will catch any model ID string mismatches if types are used elsewhere).
  Run `npm run lint` — must pass clean.
  Grep for any remaining `gemini-3-pro"` (without `-preview`) across src/ to ensure no stale references.
  Grep for `Coming Soon` across src/ to ensure badge is removed.
  Grep for `disabled: true` in mode-selector.tsx to ensure standard mode is enabled.
  </verify>
  <done>
  The MODELS config uses `gemini-3-pro-preview` as both key and id. The model-selector.tsx uses `gemini-3-pro-preview` as the id. Standard mode is enabled in mode-selector.tsx (disabled: false, badge: null). No stale `gemini-3-pro` references remain in src/. Build and lint pass clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix validation schemas and standard mode UX</name>
  <files>
    src/lib/validation/generation.ts
    src/components/generation/standard-mode-flow.tsx
  </files>
  <action>
  Fix the validation schema to allow standard mode submissions, update model ID enums, and add required-question enforcement and minimum-answer warning to standard mode flow.

  **src/lib/validation/generation.ts:**
  - Remove `.min(50, ...)` from the `brainDump` field in `GenerationRequestSchema`. Keep `.max(15000, ...)`.
  - Add a `.refine()` to the entire `GenerationRequestSchema` object that conditionally enforces `brainDump.length >= 50` only when `mode === "fast"`. Use this exact pattern:
    ```
    .refine(
      (data) => {
        if (data.mode === "fast") {
          return data.brainDump.length >= 50;
        }
        return true;
      },
      {
        message: "Please provide at least 50 characters to generate a meaningful FRD",
        path: ["brainDump"],
      },
    )
    ```
  - Note: `.refine()` is safe here because this schema validates API input, NOT Gemini structured output.
  - Update `modelId` enum in `GenerationRequestSchema` from `["gemini-2.5-flash", "gemini-3-pro"]` to `["gemini-2.5-flash", "gemini-3-pro-preview"]`
  - Update `modelId` enum in `GapDetectionRequestSchema` from `["gemini-2.5-flash", "gemini-3-pro"]` to `["gemini-2.5-flash", "gemini-3-pro-preview"]`

  **src/components/generation/standard-mode-flow.tsx:**
  - Add a `requiredUnanswered` state check in `handleNext()`: When the current question is `required: true` and the answer is empty/whitespace-only, do NOT advance. Instead, show inline validation feedback. Add a state variable `showRequiredWarning` (boolean). When `handleNext` is called on a required question with no answer, set `showRequiredWarning` to true. Reset it when the user types or navigates. Display a `<p className="text-sm text-red-500 mt-1">This question is required</p>` below the textarea when `showRequiredWarning` is true.
  - Keep the Skip button hidden for required questions (existing behavior is correct).
  - In `handleFinish()`, before calling `onSubmit`, check `answeredCount`. If `answeredCount < 2`, show a non-blocking warning. Add a `showMinAnswerWarning` state. When finish is called with < 2 answers, set `showMinAnswerWarning` to true and return without submitting. Render a warning banner: `<div className="rounded-lg bg-amber-50 border border-amber-200 p-3 text-sm text-amber-700">For best results, answer at least 2 questions. <button onClick={forceSubmit}>Generate anyway</button></div>`. The "Generate anyway" button calls `onSubmit` directly, bypassing the warning. This satisfies STND-02 (user can still skip) while preventing low-quality FRDs.
  </action>
  <verify>
  Run `npm run build` — must pass with zero errors.
  Run `npm run lint` — must pass clean.
  Verify the GenerationRequestSchema allows `{ mode: "standard", brainDump: "" }` by reading the schema structure.
  Verify the GenerationRequestSchema still rejects `{ mode: "fast", brainDump: "short" }` by reading the refine logic.
  Verify both modelId enums contain `gemini-3-pro-preview`.
  </verify>
  <done>
  GenerationRequestSchema accepts empty brainDump when mode is "standard" and rejects brainDump under 50 chars when mode is "fast". Both modelId enums use "gemini-3-pro-preview". StandardModeFlow enforces required questions (cannot advance without answering) and shows a non-blocking warning when fewer than 2 questions are answered before generation, with a "Generate anyway" escape hatch. Build and lint pass clean.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify gap detection pipeline is wired end-to-end (FAST-02 through FAST-05)</name>
  <files>
    src/app/api/analyze-gaps/route.ts
    src/lib/ai/gap-detection-engine.ts
    src/lib/ai/gap-detection-schema.ts
    src/lib/ai/templates/gap-detection.ts
    src/components/generation/gap-follow-ups.tsx
    src/components/generation/generation-flow.tsx
    src/lib/ai/prompt-composer.ts
  </files>
  <action>
  This is a VERIFICATION-ONLY task. Do NOT implement new code. Read each file and confirm the gap detection pipeline is correctly wired. If any link is broken, report the break — do not fix it in this plan (a gap closure plan would handle it).

  **Verify FAST-02 (brain dump triggers gap detection):**
  - Read `src/components/generation/generation-flow.tsx` and confirm `handleBrainDumpSubmit` calls `authedFetch("/api/analyze-gaps", ...)` with `projectName`, `brainDump`, and `modelId` in the POST body.
  - Read `src/app/api/analyze-gaps/route.ts` and confirm it validates input with `GapDetectionRequestSchema.parse(body)`, calls `analyzeGaps(...)`, and returns the result as JSON.
  - Read `src/lib/ai/gap-detection-engine.ts` and confirm `analyzeGaps` uses `generateText` with `Output.object({ schema: GapSchema })` for structured output.
  - Read `src/lib/ai/gap-detection-schema.ts` and confirm `GapSchema` defines `gaps` array with `section`, `description`, `followUpPrompt`, and `importance` fields.

  **Verify FAST-03 (gap detection results rendered as follow-up prompts):**
  - Read `src/components/generation/generation-flow.tsx` and confirm that when `data.gaps.length > 0`, the state transitions to `"follow-ups"`, and the `GapFollowUps` component renders with `gaps`, `onSubmit`, and `onSkipAll` props.
  - Read `src/components/generation/gap-follow-ups.tsx` and confirm it renders each gap's `section`, `description`, `followUpPrompt`, and `importance` with appropriate styling and a textarea for each answer.

  **Verify FAST-04 (user can skip any follow-up without breaking flow):**
  - Read `src/components/generation/gap-follow-ups.tsx` and confirm the `onSkipAll` handler exists and is wired to a "Skip & Generate Now" button.
  - Confirm that individual gaps default to unanswered (textarea placeholder says "optional") and that `handleSubmit` only collects non-empty answers — skipped gaps are simply not included.
  - Read `src/components/generation/generation-flow.tsx` and confirm `onSkipAll` calls `generateWithInput(brainDump, [])` — passing an empty follow-up array, which is valid.

  **Verify FAST-05 (follow-up answers merge with brain dump for generation):**
  - Read `src/components/generation/generation-flow.tsx` and confirm `generateWithInput` sends `followUpAnswers` in the POST body to `/api/generate`.
  - Read `src/lib/ai/prompt-composer.ts` and confirm `composeGenerationPrompt` handles `input.followUpAnswers` — iterating over them and appending `[section] question / Answer: answer` to the prompt when mode is `"fast"`.
  </action>
  <verify>
  All verification is code-reading. For each checkpoint below, grep to confirm the pattern exists:
  1. `grep -n "analyze-gaps" src/components/generation/generation-flow.tsx` — confirms brain dump triggers gap detection call
  2. `grep -n "analyzeGaps" src/app/api/analyze-gaps/route.ts` — confirms API route calls gap detection engine
  3. `grep -n "Output.object" src/lib/ai/gap-detection-engine.ts` — confirms structured output is used
  4. `grep -n "GapFollowUps" src/components/generation/generation-flow.tsx` — confirms follow-up UI renders
  5. `grep -n "onSkipAll" src/components/generation/gap-follow-ups.tsx` — confirms skip-all functionality exists
  6. `grep -n "followUpAnswers" src/lib/ai/prompt-composer.ts` — confirms follow-up answers merge into prompt
  7. `grep -n "followUpAnswers" src/components/generation/generation-flow.tsx` — confirms answers sent to generate API
  </verify>
  <done>
  All seven verification checks pass. The gap detection pipeline is confirmed wired end-to-end: brain dump → analyze-gaps API → gap detection engine (structured output) → gap follow-ups UI → skip or answer → follow-up answers merged into generation prompt. No broken links found (or broken links documented for gap closure plan if discovered).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero errors
3. No remaining `gemini-3-pro"` references (without `-preview`) in src/ — run: `grep -r '"gemini-3-pro"' src/`
4. No remaining `Coming Soon` in mode-selector.tsx
5. Standard mode `disabled: false` in mode-selector.tsx
6. `GenerationRequestSchema` has `.refine()` for conditional brainDump validation
7. Both `GenerationRequestSchema` and `GapDetectionRequestSchema` use `gemini-3-pro-preview` in modelId enum
8. `StandardModeFlow` has required-question enforcement in `handleNext()`
9. `StandardModeFlow` has minimum-answer warning in `handleFinish()`
10. Gap detection pipeline verified: brain dump → analyze-gaps API → gap-detection-engine → gap-follow-ups UI → generate API with follow-up answers
11. Skip-all functionality confirmed: onSkipAll calls generateWithInput with empty follow-up array
12. Prompt composer confirmed: followUpAnswers appended to generation prompt in fast mode
</verification>

<success_criteria>
- Both Fast and Standard modes are selectable in the UI (no disabled state, no badge)
- Gemini 3 Pro uses the correct model ID `gemini-3-pro-preview` across all layers (server config, client selector, validation schemas)
- Standard mode requests with empty brainDump pass validation; Fast mode requests with < 50 chars fail validation
- Standard mode enforces required questions and warns on low answer count
- Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-dual-mode-input-gap-detection/02-01-SUMMARY.md`
</output>
