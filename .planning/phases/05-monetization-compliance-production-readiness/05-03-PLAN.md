---
phase: 05-monetization-compliance-production-readiness
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - tests/lib/db/credits.test.ts
  - tests/lib/db/retention.test.ts
  - tests/api/generate-credits.test.ts
  - tests/api/webhooks-stripe.test.ts
  - tests/components/credits/generation-flow-credits.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests verify that chargeCredits rejects when balance is insufficient and returns correct balance"
    - "Tests verify that chargeCredits deducts correct amount and records transaction with metadata"
    - "Tests verify that generate route returns 402 on insufficient credits with balance and required fields"
    - "Tests verify that generate route returns 403 when user has not consented"
    - "Tests verify that Stripe webhook skips duplicate session IDs without adding credits"
    - "Tests verify that retention chunked deletion respects Firestore batch limit"
    - "Tests verify credit costs match CRED-01 (50 for initial) and CRED-02 (25 for iteration)"
  artifacts:
    - path: "tests/lib/db/credits.test.ts"
      provides: "Unit tests for chargeCredits, addCredits, getCredits"
    - path: "tests/lib/db/retention.test.ts"
      provides: "Unit tests for deleteExpiredData with batch chunking"
    - path: "tests/api/generate-credits.test.ts"
      provides: "Integration tests for generate route credit charging, consent, and refund"
    - path: "tests/api/webhooks-stripe.test.ts"
      provides: "Integration tests for Stripe webhook idempotency"
    - path: "tests/components/credits/generation-flow-credits.test.ts"
      provides: "Component tests for credit display and gating in GenerationFlow"
  key_links:
    - from: "tests/api/generate-credits.test.ts"
      to: "src/app/api/generate/route.ts"
      via: "Direct handler import and mock dependencies"
      pattern: "import.*POST.*from.*generate/route"
    - from: "tests/lib/db/credits.test.ts"
      to: "src/lib/db/credits.ts"
      via: "Direct function import with mocked Firestore"
      pattern: "import.*chargeCredits.*from"
---

<objective>
Write comprehensive tests for all Phase 5 credit, webhook, retention, and consent requirements. These tests serve as regression guards verifying that credit charging, idempotent webhooks, batch-safe retention, consent enforcement, and client-side credit gating all work correctly.

Purpose: Phase 5 introduces financial transactions (credit charging, Stripe webhooks) where bugs have direct monetary impact. Tests are essential regression guards for the credit system, webhook idempotency, and data retention. They also document the expected behavior for every Phase 5 requirement.

Output: 5 test files covering all Phase 5 requirements with passing tests.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monetization-compliance-production-readiness/05-01-SUMMARY.md
@.planning/phases/05-monetization-compliance-production-readiness/05-02-SUMMARY.md
@src/lib/db/credits.ts
@src/lib/db/retention.ts
@src/lib/db/consent.ts
@src/app/api/generate/route.ts
@src/app/api/webhooks/stripe/route.ts
@src/lib/stripe/config.ts
@tests/api/generate.test.ts
@tests/lib/auth/require-auth.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for credit system, consent enforcement, and generate route credit flow</name>
  <files>tests/lib/db/credits.test.ts, tests/api/generate-credits.test.ts</files>
  <action>
**Credits unit tests (`tests/lib/db/credits.test.ts`):**

Follow the established pattern from `tests/lib/auth/require-auth.test.ts` for mocking server-only and Firestore.

Mock `server-only` (no-op), mock `@/lib/db/admin` to return a mock `getDb`. Use Firestore transaction mocking pattern: `runTransaction` calls the callback with a mock `tx` object that has `get`, `set`, `update` methods.

Test cases:
1. `getCredits` — returns 0 for non-existent user
2. `getCredits` — returns balance for existing user
3. `chargeCredits` — rejects when balance insufficient, returns `{ success: false, balance: currentBalance }` (CRED-04)
4. `chargeCredits` — deducts correct amount, returns `{ success: true, balance: newBalance }` (CRED-01)
5. `chargeCredits` — records transaction with metadata including projectId, model, reason (CRED-06)
6. `addCredits` — adds credits and records purchase transaction
7. `addCredits` — creates credit doc for new user (merge: true)

**Generate route credit tests (`tests/api/generate-credits.test.ts`):**

Follow the established pattern from `tests/api/generate.test.ts` for mocking server-only, auth, and DB layers.

Mock: `server-only`, `@/lib/auth/require-auth` (return `{ userId: "test-user" }`), `@/lib/db/credits` (chargeCredits, addCredits), `@/lib/db/consent` (hasUserConsented), `@/lib/db/projects` (getProjectForUser, updateProject), `@/lib/db/versions` (saveVersion, getVersion), `@/lib/ai/generation-engine` (generateFRD), `@/lib/ai/prompt-composer` (composeGenerationPrompt), `@/lib/ai/frd-renderer` (renderFRDToMarkdown), `@/lib/analytics` (trackEvent), `@/lib/logger` (createLogger), `@/lib/rate-limit` (checkRateLimit).

Test cases:
1. Returns 402 when chargeCredits returns `{ success: false }` with balance and required in body (CRED-04)
2. Returns 403 when hasUserConsented returns false (DATA-03)
3. Charges 50 credits for initial generation — verify `chargeCredits` called with `CREDIT_COSTS.initial` (CRED-01)
4. Charges 25 credits for iteration — verify `chargeCredits` called with `CREDIT_COSTS.iteration` and `reason: "iteration"` (CRED-02)
5. Calls addCredits for refund when generation throws — verify refund amount matches charge amount
6. Tracks `credits_charged` event after successful generation (CRED-06 / OBS-02)
7. Tracks `frd_generation_failed` event when generation throws
8. Credit cost values match spec: `CREDIT_COSTS.initial === 50`, `CREDIT_COSTS.iteration === 25`
  </action>
  <verify>
Run `npx vitest run tests/lib/db/credits.test.ts tests/api/generate-credits.test.ts` — all tests pass. Run `npm run lint` — no errors.
  </verify>
  <done>
Credits unit tests cover getCredits, chargeCredits (success + failure + metadata), and addCredits. Generate route tests cover 402, 403, cost amounts, refund on failure, and event tracking. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for webhook idempotency, retention chunking, and client credit gating</name>
  <files>tests/api/webhooks-stripe.test.ts, tests/lib/db/retention.test.ts, tests/components/credits/generation-flow-credits.test.ts</files>
  <action>
**Stripe webhook tests (`tests/api/webhooks-stripe.test.ts`):**

Mock `server-only`, `@/lib/stripe/config` (getStripe with mock `webhooks.constructEvent`), `@/lib/db/credits` (addCredits), `@/lib/db/admin` (getDb — for idempotency query), `@/lib/analytics` (trackEvent), `@/lib/logger` (createLogger).

Test cases:
1. Returns 400 when stripe-signature header is missing
2. Returns 400 when constructEvent throws (invalid signature)
3. Adds credits on valid `checkout.session.completed` event
4. Skips credit addition when session ID already exists in credit_transactions (idempotency)
5. Returns `{ received: true }` on success
6. Returns `{ received: true }` even on duplicate (not an error)

**Retention tests (`tests/lib/db/retention.test.ts`):**

Mock `server-only`, `@/lib/db/admin` (getDb). Create mock Firestore collections/queries that return configurable document sets.

Test cases:
1. Deletes project and all versions for expired project
2. Does not delete projects newer than 90 days
3. Handles project with zero versions (just deletes project doc)
4. Chunks deletions when version count exceeds 499 — verify multiple `batch.commit()` calls
5. Deletes expired credit_transactions
6. Chunks credit_transaction deletions when count exceeds 499

For the chunking test: create a mock that returns 600 version docs. Verify that `batch.commit()` is called twice (first batch of 499 versions, second batch of remaining 101 versions + project doc).

**Client credit gating tests (`tests/components/credits/generation-flow-credits.test.ts`):**

This tests the GenerationFlow component's credit display and gating behavior. Use the testing pattern from `tests/components/generation/` directory.

Mock `@/hooks/use-authed-fetch` to return a mock fetch. Mock credit balance API response.

Test cases:
1. Displays credit balance and cost notice when balance is loaded
2. Shows amber warning when balance is less than 50 (insufficient)
3. Shows blue info when balance is 50 or more (sufficient)
4. Does not submit when balance is insufficient (verify no /api/generate call made)
5. Handles 402 response by showing insufficient credits error with balance info

Note: Keep component tests focused on the credit-related behavior, not the full generation flow (that's tested elsewhere).
  </action>
  <verify>
Run `npx vitest run tests/api/webhooks-stripe.test.ts tests/lib/db/retention.test.ts tests/components/credits/generation-flow-credits.test.ts` — all tests pass. Run `npm test` — all project tests pass. Run `npm run lint` — no errors.
  </verify>
  <done>
Webhook tests verify idempotency and duplicate handling. Retention tests verify chunked batch deletes for large datasets. Client tests verify credit display and gating behavior. All tests pass including existing regression tests.
  </done>
</task>

</tasks>

<verification>
1. `npm test` — all tests pass (new + existing)
2. `npm run lint` — no errors
3. `npm run build` — no TypeScript errors
4. Test coverage: chargeCredits (success/fail/metadata), addCredits (refund), getCredits (exists/not-exists), generate route (402/403/charge amounts/refund/tracking), webhook (idempotency), retention (chunking), GenerationFlow credits (display/gating/402)
5. Each Phase 5 requirement has at least one test: CRED-01 through CRED-06, DATA-01, DATA-02, DATA-03, OBS-02
</verification>

<success_criteria>
- All new tests pass
- All existing tests still pass (no regressions)
- Every Phase 5 requirement has at least one test
- Credit amounts (50 initial, 25 iteration) are verified in tests
- Webhook idempotency verified with duplicate session test
- Retention chunking verified with >499 document test
- Client credit gating verified with component tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-monetization-compliance-production-readiness/05-03-SUMMARY.md`
</output>
