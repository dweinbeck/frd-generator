---
phase: 05-monetization-compliance-production-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/generation/generation-flow.tsx
  - src/components/version/iteration-input.tsx
  - src/components/version/project-view.tsx
autonomous: true

must_haves:
  truths:
    - "User sees credit cost (50 credits) and their current balance before initial generation"
    - "User sees credit cost (25 credits) and their current balance before iteration"
    - "Generate button is disabled and shows clear message when credits are insufficient for initial generation"
    - "Iterate button is disabled and shows clear message when credits are insufficient for iteration"
    - "When server returns 402, UI shows friendly insufficient credits message with balance info"
  artifacts:
    - path: "src/components/generation/generation-flow.tsx"
      provides: "Client-side credit gating for initial generation with 402 handling"
      contains: "creditBalance.*GENERATION_COST"
    - path: "src/components/version/iteration-input.tsx"
      provides: "Credit cost display (25 credits) and insufficient credits blocking for iterations"
      contains: "ITERATION_COST"
    - path: "src/components/version/project-view.tsx"
      provides: "Credit balance prop passing to IterationInput"
      contains: "creditBalance"
  key_links:
    - from: "src/components/generation/generation-flow.tsx"
      to: "/api/credits"
      via: "useEffect fetch for credit balance"
      pattern: "api/credits"
    - from: "src/components/version/iteration-input.tsx"
      to: "/api/credits"
      via: "useEffect fetch for credit balance OR prop from parent"
      pattern: "creditBalance"
    - from: "src/components/generation/generation-flow.tsx"
      to: "/api/generate"
      via: "402 status check on response"
      pattern: "status.*402|402"
---

<objective>
Add client-side credit gating to GenerationFlow and IterationInput so users see costs upfront and are blocked from generating when they have insufficient credits. Handle 402 responses gracefully with actionable error messages.

Purpose: Users must know the cost before generating (CRED-03) and be blocked when insufficient (CRED-04). The server-side check is authoritative, but client-side gating prevents unnecessary API calls and provides a better UX. The 402 handler covers the race condition where balance changes between UI display and server charge.

Output: Three updated client components with credit cost displays, pre-submit balance checks, and 402 response handling.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/generation/generation-flow.tsx
@src/components/version/iteration-input.tsx
@src/components/version/project-view.tsx
@src/lib/stripe/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client-side credit gating to GenerationFlow with 402 handling</name>
  <files>src/components/generation/generation-flow.tsx</files>
  <action>
In `src/components/generation/generation-flow.tsx`:

1. **Add generation cost constant** near the top of the component:
   ```typescript
   const GENERATION_COST = 50;
   ```

2. **Add pre-submit credit check** in `handleBrainDumpSubmit`, right at the top before `setBrainDump(text)`:
   ```typescript
   if (creditBalance !== null && creditBalance < GENERATION_COST) {
     setError("Insufficient credits. You need 50 credits to generate an FRD. Purchase more credits to continue.");
     return;
   }
   ```

3. **Add same pre-submit credit check** in `handleStandardSubmit`, at the top before `setState("generating")`:
   ```typescript
   if (creditBalance !== null && creditBalance < GENERATION_COST) {
     setError("Insufficient credits. You need 50 credits to generate an FRD. Purchase more credits to continue.");
     return;
   }
   ```

4. **Add 402 handling** in `generateWithInput`, in the `if (!res.ok)` block. Replace the generic error handling with specific 402 detection:
   ```typescript
   if (!res.ok) {
     if (res.status === 402) {
       const data = await res.json();
       setError(`Insufficient credits. You have ${data.balance} credits but need ${data.required}. Purchase more credits to continue.`);
       setCreditBalance(data.balance); // Update displayed balance
       setState("error");
       return;
     }
     const data = await res.json();
     throw new Error(data.error || "Generation failed");
   }
   ```

5. **Add 402 handling** in `handleStandardSubmit` similarly:
   ```typescript
   if (!res.ok) {
     if (res.status === 402) {
       const data = await res.json();
       setError(`Insufficient credits. You have ${data.balance} credits but need ${data.required}. Purchase more credits to continue.`);
       setCreditBalance(data.balance);
       setState("error");
       return;
     }
     const data = await res.json();
     throw new Error(data.error || "Generation failed");
   }
   ```

6. **Update the credit notice** to show a warning style when balance is insufficient:
   ```typescript
   const isInsufficientCredits = creditBalance !== null && creditBalance < GENERATION_COST;
   const creditNotice =
     creditBalance !== null ? (
       <div className={`rounded-lg px-3 py-2 text-sm ${
         isInsufficientCredits
           ? "bg-amber-50 text-amber-700 border border-amber-200"
           : "bg-blue-50 text-blue-700"
       }`}>
         This generation costs <span className="font-semibold">50 credits</span>. Your balance:{" "}
         <span className="font-semibold">{creditBalance} credits</span>.
         {isInsufficientCredits && (
           <span className="block mt-1 font-medium">Purchase more credits to generate.</span>
         )}
       </div>
     ) : null;
   ```

7. **Handle 403 (consent not given)** in both `generateWithInput` and `handleStandardSubmit`: Add a check for 403 status alongside the 402 check:
   ```typescript
   if (res.status === 403) {
     const data = await res.json();
     setError(data.error || "You must accept the terms of use before generating.");
     setState("error");
     return;
   }
   ```
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Run `npm run lint` — no Biome errors. Verify: GenerationFlow has pre-submit credit check, 402/403 handling in both fast and standard submit paths, and warning-styled credit notice when balance is insufficient.
  </verify>
  <done>
GenerationFlow blocks generation client-side when credits are insufficient, shows amber warning when balance is too low, handles 402 responses with specific balance info, and handles 403 (consent) responses with clear messaging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add credit cost display and gating to IterationInput with 402 handling</name>
  <files>src/components/version/iteration-input.tsx, src/components/version/project-view.tsx</files>
  <action>
**IterationInput (`src/components/version/iteration-input.tsx`):**

1. **Add creditBalance prop** to the `IterationInputProps` interface:
   ```typescript
   interface IterationInputProps {
     projectId: string;
     projectName: string;
     parentVersionId: string;
     modelId: string;
     creditBalance: number | null;
     onComplete: (markdown: string, versionId: string) => void;
     onCancel: () => void;
   }
   ```
   Destructure `creditBalance` from props.

2. **Add iteration cost constant**:
   ```typescript
   const ITERATION_COST = 25;
   ```

3. **Add pre-submit credit check** in `handleSubmit`, right after `if (!feedback.trim()) return;`:
   ```typescript
   if (creditBalance !== null && creditBalance < ITERATION_COST) {
     setError("Insufficient credits. You need 25 credits for an iteration. Purchase more credits to continue.");
     return;
   }
   ```

4. **Add 402 and 403 handling** in the `if (!res.ok)` block:
   ```typescript
   if (!res.ok) {
     if (res.status === 402) {
       const data = await res.json();
       setError(`Insufficient credits. You have ${data.balance} credits but need ${data.required}. Purchase more credits to continue.`);
       setIsSubmitting(false);
       return;
     }
     if (res.status === 403) {
       const data = await res.json();
       setError(data.error || "You must accept the terms of use first.");
       setIsSubmitting(false);
       return;
     }
     const data = await res.json();
     throw new Error(data.error || "Iteration failed");
   }
   ```

5. **Add credit cost notice** in the form JSX, between the textarea wrapper `</div>` and the error display:
   ```tsx
   {/* CRED-03: Show iteration cost */}
   {creditBalance !== null && (
     <div className={`rounded-lg px-3 py-2 text-sm ${
       creditBalance < ITERATION_COST
         ? "bg-amber-50 text-amber-700 border border-amber-200"
         : "bg-blue-50 text-blue-700"
     }`}>
       This iteration costs <span className="font-semibold">25 credits</span>. Your balance:{" "}
       <span className="font-semibold">{creditBalance} credits</span>.
       {creditBalance < ITERATION_COST && (
         <span className="block mt-1 font-medium">Purchase more credits to iterate.</span>
       )}
     </div>
   )}
   ```

6. **Disable submit button** when credits are insufficient: Update the disabled condition on the submit button:
   ```typescript
   disabled={isSubmitting || !feedback.trim() || (creditBalance !== null && creditBalance < ITERATION_COST)}
   ```

**ProjectView (`src/components/version/project-view.tsx`):**

1. **Add creditBalance state** in the component:
   ```typescript
   const [creditBalance, setCreditBalance] = useState<number | null>(null);
   ```

2. **Add useEffect to fetch credit balance**:
   ```typescript
   useEffect(() => {
     async function fetchBalance() {
       try {
         const res = await authedFetch("/api/credits");
         if (res.ok) {
           const data = await res.json();
           setCreditBalance(data.balance);
         }
       } catch {
         // Non-critical
       }
     }
     fetchBalance();
   }, [authedFetch]);
   ```

3. **Pass creditBalance to IterationInput**: In the JSX where `IterationInput` is rendered (around line 212), add the prop:
   ```tsx
   <IterationInput
     projectId={projectId}
     projectName={projectName}
     parentVersionId={activeVersionId}
     modelId="gemini-2.5-flash"
     creditBalance={creditBalance}
     onComplete={handleIterationComplete}
     onCancel={() => setViewMode("view")}
   />
   ```

4. **Refresh balance after iteration completes**: In `handleIterationComplete`, re-fetch the credit balance:
   ```typescript
   function handleIterationComplete(newMarkdown: string, newVersionId: string) {
     setActiveVersionId(newVersionId);
     setMarkdown(newMarkdown);
     setRating(undefined);
     setViewMode("view");
     setVersionListKey((prev) => prev + 1);
     // Refresh credit balance after iteration
     authedFetch("/api/credits").then(res => {
       if (res.ok) res.json().then(data => setCreditBalance(data.balance));
     }).catch(() => {});
   }
   ```
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Run `npm run lint` — no Biome errors. Verify: IterationInput shows 25-credit cost notice, blocks submit when insufficient, handles 402/403. ProjectView fetches credit balance and passes it to IterationInput.
  </verify>
  <done>
IterationInput shows credit cost (25 credits) and current balance, disables submit when insufficient, handles 402/403 responses. ProjectView fetches credit balance and passes it as prop, refreshes balance after iteration.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `npm run lint` passes with no Biome errors
3. GenerationFlow shows credit cost (50) and balance, blocks when insufficient
4. IterationInput shows credit cost (25) and balance, blocks when insufficient
5. Both components handle 402 and 403 responses gracefully
6. Credit balance refreshes after iteration in ProjectView
</verification>

<success_criteria>
- User sees "This generation costs 50 credits. Your balance: X credits." before initial generation
- User sees "This iteration costs 25 credits. Your balance: X credits." before iteration
- Warning style (amber) shown when balance is insufficient
- Submit buttons disabled when credits are insufficient
- 402 response shows specific balance/required info
- 403 response shows consent required message
</success_criteria>

<output>
After completion, create `.planning/phases/05-monetization-compliance-production-readiness/05-02-SUMMARY.md`
</output>
