---
phase: 04-authentication-privacy
plan: 02
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - tests/lib/auth/require-auth.test.ts
  - tests/lib/auth/verify-token.test.ts
  - tests/lib/privacy-audit.test.ts
autonomous: true

must_haves:
  truths:
    - "requireAuth returns 401 when no Authorization header is present"
    - "requireAuth returns 401 when token is invalid"
    - "requireAuth returns userId for valid tokens"
    - "verifyAuth extracts and validates Bearer tokens correctly"
    - "Logger strips sensitive fields (brainDump, prompt, content, composedPrompt) from all log output"
    - "Analytics event types do not include prompt content fields"
    - "Data isolation rejects access for non-owner userId"
  artifacts:
    - path: "tests/lib/auth/require-auth.test.ts"
      provides: "Tests for requireAuth 401 enforcement"
      contains: "status.*401"
    - path: "tests/lib/auth/verify-token.test.ts"
      provides: "Tests for verifyAuth token extraction and validation"
      contains: "verifyAuth"
    - path: "tests/lib/privacy-audit.test.ts"
      provides: "Tests auditing prompt privacy in logger, analytics, and data isolation"
      contains: "AUTH-06"
  key_links:
    - from: "tests/lib/auth/require-auth.test.ts"
      to: "src/lib/auth/require-auth.ts"
      via: "imports and tests requireAuth function"
      pattern: "import.*requireAuth"
    - from: "tests/lib/auth/verify-token.test.ts"
      to: "src/lib/auth/verify-token.ts"
      via: "imports and tests verifyAuth function"
      pattern: "import.*verifyAuth"
    - from: "tests/lib/privacy-audit.test.ts"
      to: "src/lib/logger.ts"
      via: "imports and tests createLogger sanitization"
      pattern: "import.*createLogger"
---

<objective>
Write TDD tests that verify auth enforcement (AUTH-01, AUTH-02), data isolation (AUTH-03), and prompt privacy (AUTH-05, AUTH-06) are correctly implemented after bypass removal.

Purpose: These tests serve as regression guards -- if anyone re-introduces an anonymous fallback or exposes prompt content in logs, tests fail. They also verify the critical auth contract: no token = 401, invalid token = 401, valid token = userId.

Output: 3 test files covering auth enforcement, token verification, and privacy audit.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-privacy/04-RESEARCH.md
@.planning/phases/04-authentication-privacy/04-01-SUMMARY.md
@tests/api/projects/versions/route.test.ts
</context>

<feature>
  <name>Auth Enforcement and Privacy Tests</name>
  <files>
    tests/lib/auth/require-auth.test.ts
    tests/lib/auth/verify-token.test.ts
    tests/lib/privacy-audit.test.ts
  </files>
  <behavior>
    requireAuth behavior:
    - Request with no Authorization header -> returns NextResponse with status 401
    - Request with invalid token -> returns NextResponse with status 401
    - Request with valid Firebase token -> returns { userId: "the-uid" }
    - The returned 401 response body contains { error: "Unauthorized" }

    verifyAuth behavior:
    - Request with no Authorization header -> returns null
    - Request with "Authorization: Bearer " (empty token) -> returns null
    - Request with "Authorization: Basic xxx" (wrong scheme) -> returns null
    - Request with valid Bearer token -> calls getAuth().verifyIdToken() and returns { userId: decoded.uid }
    - Request with token that fails verifyIdToken -> returns null (catches error)

    Privacy audit:
    - createLogger sanitization: metadata containing brainDump, prompt, content, composedPrompt fields are stripped before output
    - Analytics event types: AnalyticsEvent union type does not include brainDump, prompt, content, or composedPrompt fields (compile-time check)
    - getProjectForUser: returns null when userId does not match project.userId (data isolation)
  </behavior>
  <implementation>
    Follow established test patterns from tests/api/projects/versions/route.test.ts:
    - Mock server-only with vi.mock("server-only", () => ({}))
    - Mock firebase-admin/auth for verifyIdToken
    - Mock @/lib/db/admin for getDb
    - Use vi.mocked() for type-safe mock access
    - Place tests in tests/ directory (project convention, not src/__tests__/)

    For requireAuth tests: Create Request objects with/without Authorization headers, verify instanceof NextResponse for failures and plain object for success.

    For verifyAuth tests: Mock getAuth().verifyIdToken() to return decoded tokens or throw errors. Verify the function extracts Bearer tokens correctly.

    For privacy audit tests:
    - Logger: Spy on console.log, call createLogger().info() with metadata containing sensitive fields, parse the JSON output and verify sensitive fields are absent.
    - Data isolation: Mock getDb/Firestore, call getProjectForUser with mismatched userId, verify null return.
  </implementation>
</feature>

<verification>
1. RED phase: All tests written. `npm test` runs and all new tests FAIL (because mocks need proper setup or code needs verification).
   Actually -- since this is post-implementation TDD (verifying existing correct code), tests should PASS immediately. The TDD cycle here is: write tests that would FAIL if bypasses were re-introduced, verify they PASS with current code.

2. GREEN phase: `npm test` -- all tests pass.

3. Full quality gate: `npm run lint && npm run build && npm test` -- all green.
</verification>

<success_criteria>
- requireAuth test file exists with tests for: no header -> 401, invalid token -> 401, valid token -> userId
- verifyAuth test file exists with tests for: no header -> null, empty token -> null, wrong scheme -> null, valid token -> userId, invalid token -> null
- Privacy audit test file exists with tests for: logger sanitization strips sensitive fields, data isolation rejects non-owners
- All tests pass with `npm test`
- Tests serve as regression guards -- re-introducing "anonymous" fallback would cause test failure
- Lint and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-privacy/04-02-SUMMARY.md`
</output>
