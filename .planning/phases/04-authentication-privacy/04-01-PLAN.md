---
phase: 04-authentication-privacy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/require-auth.ts
  - src/hooks/use-authed-fetch.ts
  - src/app/page.tsx
  - src/app/projects/[projectId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated API requests receive 401 Unauthorized (not anonymous fallback)"
    - "Unauthenticated page visits redirect to /sign-in (not rendered with bypassed auth)"
    - "All client API calls use authedFetch with Bearer token (no raw fetch)"
    - "Auth guards check loading state before rendering page content"
  artifacts:
    - path: "src/lib/auth/require-auth.ts"
      provides: "Server-side auth enforcement returning 401 for unauthenticated requests"
      contains: "NextResponse.json.*401"
    - path: "src/hooks/use-authed-fetch.ts"
      provides: "Client fetch hook that returns synthetic 401 when no token available"
      contains: "status: 401"
    - path: "src/app/page.tsx"
      provides: "Home page with auth guard, useAuth, and authedFetch"
      contains: "useAuth"
    - path: "src/app/projects/[projectId]/page.tsx"
      provides: "Project page with auth guard and user in useEffect dependencies"
      contains: "user.*dependency"
  key_links:
    - from: "src/lib/auth/require-auth.ts"
      to: "src/lib/auth/verify-token.ts"
      via: "verifyAuth() call"
      pattern: "verifyAuth\\(req\\)"
    - from: "src/hooks/use-authed-fetch.ts"
      to: "src/lib/firebase/auth-context.tsx"
      via: "getIdToken() from useAuth"
      pattern: "getIdToken\\(\\)"
    - from: "src/app/page.tsx"
      to: "src/hooks/use-authed-fetch.ts"
      via: "useAuthedFetch hook for API calls"
      pattern: "authedFetch\\("
    - from: "src/app/page.tsx"
      to: "/sign-in"
      via: "router.push redirect when no user"
      pattern: "router\\.push.*sign-in"
---

<objective>
Remove all auth bypasses across the 3-layer auth architecture (server requireAuth, client fetch hook, page guards) to enforce real Firebase Auth on every request.

Purpose: This activates the auth infrastructure scaffolded in Phase 1. The bypasses were intentional for pre-auth development. Now that Phases 1-3 are complete and Firebase Auth is available, every layer must enforce real authentication.

Output: All 9 bypass locations across 5 files are removed. Unauthenticated requests get 401, unauthenticated page visits redirect to /sign-in.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-privacy/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove server and fetch hook auth bypasses</name>
  <files>src/lib/auth/require-auth.ts, src/hooks/use-authed-fetch.ts</files>
  <action>
**File 1: `src/lib/auth/require-auth.ts`** (Bypass location: line 13)

Remove the anonymous fallback. When `verifyAuth(req)` returns null, return a 401 NextResponse instead of `{ userId: "anonymous" }`.

Replace lines 10-14 with:
```typescript
const auth = await verifyAuth(req);
if (!auth) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
return auth;
```

Remove the TODO comment on line 10. Keep the JSDoc comment above the function explaining the `instanceof NextResponse` pattern that API routes use.

**File 2: `src/hooks/use-authed-fetch.ts`** (Bypass location: lines 17-18)

Remove the unauthenticated fetch fallback. When `getIdToken()` returns null, return a synthetic 401 Response so callers handle it uniformly (same way they handle a real server 401).

Replace lines 16-18 with:
```typescript
if (!token) {
  return new Response(JSON.stringify({ error: "Not authenticated" }), {
    status: 401,
    headers: { "Content-Type": "application/json" },
  });
}
```

Remove the TODO comment on line 16. This pattern (synthetic 401 instead of throwing) is deliberate -- callers already handle 401 responses (e.g., project page line 52: `if (res.status === 401) { router.push("/sign-in"); }`).

Do NOT throw an Error here. The project page already handles 401 status gracefully. Throwing would require try/catch at every call site.
  </action>
  <verify>
Run `npx biome check src/lib/auth/require-auth.ts src/hooks/use-authed-fetch.ts` to verify no lint errors.

Run `npm run build` to verify TypeScript compilation succeeds.

Grep for remaining "anonymous" bypass: `grep -r "anonymous" src/lib/auth/ src/hooks/` should return no results.

Grep for remaining Phase 4 TODOs in these files: `grep -r "TODO.*Phase 4" src/lib/auth/require-auth.ts src/hooks/use-authed-fetch.ts` should return no results.
  </verify>
  <done>
`requireAuth()` returns 401 NextResponse for unauthenticated requests (not `{ userId: "anonymous" }`). `useAuthedFetch()` returns synthetic 401 Response when no token available (not unauthenticated fetch fallback). No "anonymous" string remains in auth code. No Phase 4 TODOs remain in these files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restore auth guards on home page and project page</name>
  <files>src/app/page.tsx, src/app/projects/[projectId]/page.tsx</files>
  <action>
**File 1: `src/app/page.tsx`** (Bypass locations: lines 6-8, 14, 28-32, 46)

There are 4 bypass locations in this file. Fix all of them:

1. **Lines 6-8 (commented imports):** Uncomment the `useAuthedFetch` and `useAuth` imports:
```typescript
import { useAuthedFetch } from "@/hooks/use-authed-fetch";
import { useAuth } from "@/lib/firebase/auth-context";
```

2. **Line 14 (hardcoded authLoading):** Replace `const authLoading = false;` with:
```typescript
const { user, loading: authLoading } = useAuth();
const authedFetch = useAuthedFetch();
```

3. **Lines 28-32 (commented auth guard):** Uncomment the auth guard block:
```typescript
if (!user) {
  router.push("/sign-in");
  return null;
}
```

4. **Line 46 (raw fetch):** Replace the raw `fetch("/api/projects", ...)` call with `authedFetch("/api/projects", ...)`. Keep the same options (method, headers, body). Also add 401 handling after the `!res.ok` check:
```typescript
const res = await authedFetch("/api/projects", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ name: name.trim(), mode }),
});

if (res.status === 401) {
  router.push("/sign-in");
  return;
}
```

Remove ALL TODO comments mentioning Phase 4 from this file. Remove the old `// import` commented lines entirely.

**File 2: `src/app/projects/[projectId]/page.tsx`** (Bypass locations: lines 29, 39-43, 67)

There are 3 bypass locations in this file. Fix all of them:

1. **Line 29 (user not destructured):** Change `const { loading: authLoading } = useAuth();` to:
```typescript
const { user, loading: authLoading } = useAuth();
```

2. **Lines 39-43 (commented auth guard in useEffect):** Uncomment the auth guard:
```typescript
if (!user) {
  router.push("/sign-in");
  return;
}
```

3. **Line 67 (user not in dependency array):** Add `user` to the useEffect dependency array:
```typescript
}, [params.projectId, authLoading, authedFetch, router, user]);
```

Remove ALL TODO comments mentioning Phase 4 from this file.
  </action>
  <verify>
Run `npx biome check src/app/page.tsx src/app/projects/\\[projectId\\]/page.tsx` to verify no lint errors.

Run `npm run build` to verify TypeScript compilation succeeds.

Grep for remaining Phase 4 TODOs across entire src: `grep -rn "TODO.*Phase 4" src/` should return zero results related to auth bypasses (credits TODOs for Phase 5 are expected to remain in `src/app/api/generate/route.ts`).

Grep for `"anonymous"` in page files: `grep -r "anonymous" src/app/page.tsx src/app/projects/` should return no results.

Verify the string "useAuth" appears in both page files (not commented out).
  </verify>
  <done>
Home page uses `useAuth()` for auth state, `useAuthedFetch()` for API calls, redirects to /sign-in when not authenticated, and handles 401 responses. Project page destructures `user` from `useAuth()`, has auth guard in useEffect, includes `user` in dependency array, and handles 401 (already had this). No Phase 4 TODO comments remain in any page file. All 9 bypass locations from the research inventory are resolved.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full quality gate:

1. `npm run lint` -- zero errors
2. `npm run build` -- succeeds with no type errors
3. `npm test` -- all existing tests pass (tests mock requireAuth, so they are unaffected by the bypass removal)
4. `grep -rn "TODO.*Phase 4" src/` -- only Phase 5 credit TODOs should remain (in generate route)
5. `grep -rn '"anonymous"' src/lib/auth/ src/hooks/ src/app/page.tsx src/app/projects/` -- zero results
6. Verify the complete bypass inventory from RESEARCH.md (all 9 locations in 5 files) is resolved
</verification>

<success_criteria>
- requireAuth() returns 401 for unauthenticated requests (AUTH-02)
- useAuthedFetch() returns synthetic 401 when no token (no silent fallback)
- Home page (/) redirects to /sign-in when not authenticated
- Project page (/projects/[id]) redirects to /sign-in when not authenticated
- All API calls from pages use authedFetch (no raw fetch bypassing auth)
- Zero "Phase 4 TODO" comments remain in modified files
- Zero "anonymous" fallbacks remain in auth code
- Build, lint, and tests all pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-privacy/04-01-SUMMARY.md`
</output>
